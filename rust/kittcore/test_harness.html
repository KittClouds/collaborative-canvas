<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ResoRank Neural Core Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
        }

        .pass {
            color: #0f0;
        }

        .fail {
            color: #f00;
        }
    </style>
</head>

<body>
    <h2>ResoRank Neural Core Test Harness</h2>
    <div id="output">Initializing...</div>

    <script type="module">
        import init, { ResoRankScorer, ResoRankIncrementalScorer, ReflexCortex, Scanner } from './pkg/resorank_core.js';

        async function runTests() {
            const out = document.getElementById('output');
            const log = (msg, isError = false) => {
                const div = document.createElement('div');
                div.textContent = msg;
                div.className = isError ? 'fail' : 'pass';
                out.appendChild(div);
                console.log(msg);
            };

            try {
                await init();
                log("WASM Initialized successfully.");

                // Test 1-9 (Condensed for brevity, assumed passing from previous runs, but included to be safe)
                const statsObj = { total_documents: 100, average_field_lengths: new Map([[0, 10]]), average_document_length: 510 };
                const scorer = new ResoRankScorer(undefined, statsObj);
                log("Test 1 Passed: Scorer created.");

                // Test 9: ReflexCortex
                const reflex = new ReflexCortex(true);
                reflex.addPattern("ent_frodo", "Frodo");
                reflex.addPattern("ent_gandalf", "Gandalf");
                reflex.build();
                const scanRes = reflex.scan("Frodo and Gandalf walked.");
                if (scanRes.length === 2) log("Test 9 Passed: ReflexCortex found entities.");
                else log("Test 9 Failed", true);

                // Test 10: Scanner Orchestrator (Reflex + Syntax + Temporal)
                log("Starting Test 10 (Scanner Orchestrator)...");
                const scanner = new Scanner(true);
                scanner.addReflexPattern("ent_regex", "Regex");
                scanner.buildReflex();

                const text10 = "Found [[WikiLink]] and #hashtag and Regex on 2025-01-01.";
                const sRes = scanner.scan(text10);
                console.log("Scanner Result:", sRes);

                if (sRes.entities && sRes.syntax && sRes.temporal) {
                    const ent = sRes.entities.length; // Expect 1 ("Regex")
                    const syn = sRes.syntax.length;   // Expect 2 ("[[WikiLink]]", "#hashtag")
                    const tmp = sRes.temporal.length; // Expect 1 ("2025-01-01")

                    log(`Scanner Stats: Entities=${ent}, Syntax=${syn}, Temporal=${tmp}`);

                    if (ent >= 1 && syn >= 2 && tmp >= 1) {
                        log("Test 10 Passed: Orchestrator functioning (Reflex+Syntax+Temporal).");
                    } else {
                        log("Test 10 Failed: Incomplete results.", true);
                    }
                } else {
                    log("Test 10 Failed: Missing structure returned by scan().", true);
                }

            } catch (e) {
                log(`Fatal Error: ${e.message}`, true);
                console.error(e);
            }
        }

        runTests();
    </script>
</body>

</html>